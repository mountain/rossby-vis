# `rossby-vis` 界面与交互设计文档 (v1.0)

## 1. 核心理念与架构

### 1.1. 设计哲学：极轻便 (Extremely Lightweight)

`rossby-vis` 的核心设计哲学是 **“极轻便”**。这意味着：
* **无客户端配置:** 应用不应依赖任何本地配置文件。所有状态和设置应可完全通过 URL 承载。
* **最小化交互负担:** 界面应尽可能简洁，避免使用复杂的编辑器或需要用户“创造”内容的组件。优先提供精心设计的“选择项”。
* **高性能:** 前后端交互和渲染必须流畅，对用户的操作做出即时响应。

### 1.2. 数据源范围与通用性

本设计旨在广泛适用于符合 CF (Climate and Forecast) 元数据约定的地学、天气学和气候学 NetCDF 数据。

**首要测试场景将针对 ERA5 数据集**，以确保在主流、复杂的真实数据上获得验证。然而，**设计中的任何部分都不会与 ERA5 硬性绑定**。所有功能，如模式识别、变量分类和维度控制，都基于通用的元数据标准，而非特定于某一数据源。

### 1.3. 核心架构：模式驱动的自适应界面 (Mode-Driven Adaptive UI)

应用的核心是自适应性。它通过一个**模式 (Mode)** 系统来实现，该系统能根据加载数据的物理维度，自动调整整个界面的行为和可用选项。

| 模式 (Mode)           | 标识符 | 触发条件 (自动识别)                                         | 核心垂直坐标 |
| :---------------------- | :------- | :---------------------------------------------------------- | :------------- |
| **大气模式 (Atmosphere)** | `atm`    | 数据中包含 `pressure` 或 `level` 维度。                     | 气压 (hPa)     |
| **海洋模式 (Ocean)** | `ocn`    | 数据中包含 `depth` 维度或海洋专属变量(如 `sst`)。           | 深度 (m)       |
| **表面/普通模式 (Surface)** | `sfc`    | 数据为二维 `(time, lat, lon)`，无垂直维度。                 | 无             |

## 2. 可视化与交互模型

### 2.1. 变量呈现：“底图 + 叠加层”模型

为了解决多变量叠加带来的交互复杂性，我们采用**“底图 (Base) + 叠加层 (Overlay)”**的二元模型。

* **底图 (Base):** 通常是覆盖全图的**颜色填充 (Color Fill)** 变量，如温度、湿度。
* **叠加层 (Overlay):** 是以非覆盖性方式（如粒子、等值线）呈现在底图之上的变量，如风场、位势高度。

用户通过两个独立的下拉菜单进行选择，这两个菜单的内容会根据当前的 `Mode` 被动态筛选。

### 2.2. 变量分类示例 (以 ERA5 为例)

下表为变量在此模型下的角色分类**示例**，后端逻辑可根据元数据动态生成此分类，而非硬编码。

| 变量类别     | 变量名称示例 (Short Name) | 建议角色 | 建议渲染方式 (Renderer)   |
| :------------- | :-------------------------- | :--------- | :-------------------------- |
| **通用/地表** | `t2m`, `sst`, `msl`, `tp`, `tcc` | Base       | Color Fill                  |
| **风场** | `u10`/`v10`, `u`/`v` on Levels  | Overlay    | **Particles** (粒子动画)    |
| **位势/气压** | `z` on Levels, `msl`        | Overlay    | **Contours** (等值线)       |
| **温湿** | `t`, `r` on Levels          | Base       | Color Fill                  |
| **波浪** | `swh`                       | Base       | Color Fill                  |

### 2.3. 交互式图表元素

#### 2.3.1. 动态图例 (Dynamic Legend)

一个位于角落的半透明面板，其内容根据当前选择的变量**自动生成**，清晰解释颜色、粒子、线条所代表的物理意义、名称和单位。

#### 2.3.2. 数据探针 (Data Probe)

支持鼠标**悬停 (Hover) 或点击 (Click)** 操作。在指针位置弹出一个信息框 (Tooltip)，显示该地理坐标点上，所有已加载变量的**精确数值**。

## 3. 控件与状态管理

### 3.1. 维度控制器 (Dimension Controls)

#### 3.1.1. 高度/层级控制器

此控件将根据 `Mode` 动态变化：
* **大气模式:** 标签为 **`气压层 (Pressure Level)`**，选项为 `1000hPa`, `850hPa`...
* **海洋模式:** 标签为 **`深度 (Depth)`**，选项为 `0m`, `-50m`...
* **表面模式:** 此控件被**自动禁用或隐藏**。

#### 3.1.2. 增强的时间控制器

一个功能全面的时间控制条，包含：
* **[必需]** 播放/暂停按钮。
* **[必需]** 时间轴滑块 (Slider)。
* **[必需]** 清晰的时间戳文本显示 (格式见 3.2)。
* **[建议]** 逐帧步进按钮 (`|<` 和 `>|`)。
* **[可选]** 动画播放速度控制。

### 3.2. 时间数据处理策略

为应对不同 NetCDF 文件中多样的时间定义（如`hours since...`、`days since...`及不同日历），并为前端提供统一接口，我们采取**后端集中处理**的策略。

1.  **后端解析与转换:** 后端服务在加载 NetCDF 文件时，**必须**解析其 `time` 变量的 `units` 和 `calendar` 元数据。
2.  **构建标准时间表:** 后端将文件中的所有时间步，**一次性**转换为统一的 **ISO 8601 格式字符串** (`YYYY-MM-DDTHH:mm:ssZ`)，并在内存中维护一个索引到时间字符串的映射表。
3.  **统一 API 接口:** 所有与时间相关的后端 API，无论是向前端提供可选时间列表，还是接收前端指定的时间查询，都**只使用 ISO 8601 格式的字符串**。这使得前端的实现大大简化，并将复杂性隔离在后端。

### 3.3. 样式定制 (Style Customization)

为遵循“极轻便”哲学，样式定制**不提供“创造”功能，只提供“选择”功能**。

* **色标方案 (Colormap):** 提供一个下拉菜单，允许用户从一个**预定义的、高质量的色标方案列表**中进行选择（如 `Viridis`, `Jet`, `cmocean` 等）。

## 4. 分享与持久化

### 4.1. URL 状态化机制

应用的所有可分享状态都将被序列化到 URL 的 **hash (`#`)** 部分。

* **URL 结构:** `https://rossby-vis.app/#/view?key1=val1&key2=val2...`
* **状态同步:** 应用内的任何状态变更都应实时更新 URL hash。

### 4.2. URL 参数定义

| 参数 Key       | 描述                                                       | 示例值                     |
| :--------------- | :--------------------------------------------------------- | :--------------------------- |
| `dsrc`           | **[必需]** 数据源标识                                      | `era5-pl`, `oscar`, `custom` |
| `base`           | **[必需]** 底图变量                                        | `t`, `sst`                   |
| `ov`             | **[必需]** 叠加变量                                        | `z`, `wnd10m`, `none`        |
| `ts`             | **[必需]** ISO 8601 时间戳                                 | `2024-01-01T12:00:00Z`       |
| `lvl`            | **[条件必需]** 高度/深度层级                             | `500`, `-50`                 |
| `lon`, `lat`, `zm` | **[必需]** 视角中心点和缩放                              | `121.5`, `31.2`, `4`         |
| `proj`           | **[建议]** 投影方式                                        | `ortho`, `merc`              |
| `cmap`           | **[建议]** 色标方案                                        | `viridis`, `jet`             |

### 4.3. 用户上传文件的处理

当数据源为用户上传的文件时，**“分享”功能应被禁用**，并向用户提供清晰的提示。

## 5. 最佳实践与实施指南

### 5.1. 性能 (Performance)

* **动态数据精度 (Progressive Loading):** 根据地图缩放级别，动态请求不同分辨率的网格数据。
* **Web Workers:** 对于数据解析、插值等计算密集型任务，应考虑使用 Web Workers，避免阻塞主线程。
* **高效渲染:** 优先使用 WebGL。

### 5.2. 可访问性 (Accessibility, a11y)

集成 ARIA (Accessible Rich Internet Applications) 标准。
* **语义化 HTML:** 尽可能使用原生 HTML 元素。
* **ARIA 角色与属性:** 为所有交互控件和动态区域提供 `aria-label` 和 `aria-live` 等属性。
* **键盘导航:** 确保所有功能都可以仅通过键盘来访问和操作。